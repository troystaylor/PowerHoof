<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Hoof Chat</title>
  <style>
    :root {
      --primary: #0078d4;
      --primary-dark: #106ebe;
      --bg: #f5f5f5;
      --surface: #ffffff;
      --text: #323130;
      --text-secondary: #605e5c;
      --border: #edebe9;
      --user-msg: #e1f0ff;
      --assistant-msg: #ffffff;
      --code-bg: #1e1e1e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .header .subtitle {
      font-size: 12px;
      opacity: 0.85;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      background: #92c353;
      border-radius: 50%;
      margin-left: auto;
    }

    .status-indicator.offline { background: #d13438; }
    .status-indicator.loading { background: #ffc83d; }

    /* Chat container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Message styles */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 8px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      background: var(--user-msg);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      background: var(--assistant-msg);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .message.system {
      background: #fff4ce;
      align-self: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .message.error {
      background: #fde7e9;
      color: #a4262c;
      align-self: center;
    }

    /* Message content */
    .message pre {
      background: var(--code-bg);
      color: #d4d4d4;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 8px 0;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      font-size: 13px;
    }

    .message code {
      background: #f3f2f1;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Cascadia Code', monospace;
      font-size: 13px;
    }

    .message pre code {
      background: none;
      padding: 0;
    }

    .message h1, .message h2, .message h3 {
      margin: 16px 0 8px 0;
    }

    .message ul, .message ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .message table {
      border-collapse: collapse;
      margin: 12px 0;
      width: 100%;
    }

    .message th, .message td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
    }

    .message th {
      background: var(--bg);
      font-weight: 600;
    }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing span {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Input area */
    .input-area {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: none;
      min-height: 48px;
      max-height: 150px;
      transition: border-color 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    button {
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button:disabled {
      background: #c8c6c4;
      cursor: not-allowed;
    }

    /* Skills sidebar */
    .skills-btn {
      position: fixed;
      top: 80px;
      right: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .skills-panel {
      position: fixed;
      top: 120px;
      right: 16px;
      width: 280px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .skills-panel.open {
      display: block;
    }

    .skills-panel h3 {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .skill-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .skill-item:hover {
      background: var(--bg);
    }

    .skill-item:last-child {
      border-bottom: none;
    }

    .skill-name {
      font-weight: 600;
      font-size: 13px;
    }

    .skill-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .message {
        max-width: 95%;
      }

      .skills-btn, .skills-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <h1>üê¥ Power Hoof</h1>
      <div class="subtitle">AI Assistant with Power Platform Skills</div>
    </div>
    <div id="status" class="status-indicator"></div>
  </header>

  <button class="skills-btn" onclick="toggleSkills()">üìö Skills</button>
  
  <div id="skills-panel" class="skills-panel">
    <h3>Available Skills</h3>
    <div id="skills-list"></div>
  </div>

  <main id="chat" class="chat-container">
    <div class="message system">
      Welcome! I'm Power Hoof, your AI assistant. Type a message or try a skill command like <code>/help</code>
    </div>
  </main>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea 
        id="input" 
        placeholder="Type your message... (Shift+Enter for new line)"
        rows="1"
        onkeydown="handleKeydown(event)"
        oninput="autoResize(this)"
      ></textarea>
    </div>
    <button id="send-btn" onclick="sendMessage()">
      <span>Send</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
      </svg>
    </button>
  </div>

  <script>
    const API_URL = window.location.origin;
    let sessionId = localStorage.getItem('sessionId') || generateId();
    localStorage.setItem('sessionId', sessionId);

    function generateId() {
      return 'sess_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkHealth();
      loadSkills();
    });

    async function checkHealth() {
      const status = document.getElementById('status');
      try {
        const res = await fetch(`${API_URL}/health`);
        status.className = res.ok ? 'status-indicator' : 'status-indicator offline';
      } catch {
        status.className = 'status-indicator offline';
      }
    }

    async function loadSkills() {
      try {
        const res = await fetch(`${API_URL}/skills`);
        if (!res.ok) return;
        
        const skills = await res.json();
        const list = document.getElementById('skills-list');
        
        list.innerHTML = skills.map(s => `
          <div class="skill-item" onclick="useSkill('${s.name}')">
            <div class="skill-name">${s.name}</div>
            <div class="skill-desc">${s.description || ''}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load skills:', e);
      }
    }

    function toggleSkills() {
      document.getElementById('skills-panel').classList.toggle('open');
    }

    function useSkill(name) {
      const input = document.getElementById('input');
      input.value = `/${name.toLowerCase()} `;
      input.focus();
      toggleSkills();
    }

    function handleKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 150) + 'px';
    }

    function addMessage(role, content, isError = false) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = `message ${role}${isError ? ' error' : ''}`;
      
      // Simple markdown rendering
      div.innerHTML = renderMarkdown(content);
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function renderMarkdown(text) {
      if (!text) return '';
      
      return text
        // Code blocks
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Headers
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Links
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        // Lists
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        // Tables (basic)
        .replace(/\|(.+)\|/g, (match, content) => {
          const cells = content.split('|').map(c => c.trim());
          return '<tr>' + cells.map(c => `<td>${c}</td>`).join('') + '</tr>';
        })
        // Line breaks
        .replace(/\n/g, '<br>');
    }

    function showTyping() {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.id = 'typing';
      div.className = 'message assistant typing';
      div.innerHTML = '<span></span><span></span><span></span>';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('input');
      const btn = document.getElementById('send-btn');
      const content = input.value.trim();
      
      if (!content) return;

      // Add user message
      addMessage('user', content);
      input.value = '';
      input.style.height = 'auto';
      
      // Disable input
      btn.disabled = true;
      showTyping();

      try {
        const res = await fetch(`${API_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: content,
            sessionId: sessionId,
          }),
        });

        hideTyping();

        if (!res.ok) {
          const error = await res.json().catch(() => ({ error: 'Request failed' }));
          addMessage('assistant', error.error || 'Something went wrong', true);
          return;
        }

        const data = await res.json();
        addMessage('assistant', data.response || data.content || 'No response');
        
      } catch (e) {
        hideTyping();
        addMessage('assistant', 'Failed to connect to server. Please check if the server is running.', true);
        console.error(e);
      } finally {
        btn.disabled = false;
        input.focus();
      }
    }

    // Periodic health check
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>
